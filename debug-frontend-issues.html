<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>前端问题调试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }
        .debug-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: #f9f9f9;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 3px;
            cursor: pointer;
        }
        button:hover {
            background: #0056b3;
        }
        .result {
            margin-top: 10px;
            padding: 10px;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 3px;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
        }
        .success {
            border-color: #28a745;
            background: #d4edda;
            color: #155724;
        }
        .error {
            border-color: #dc3545;
            background: #f8d7da;
            color: #721c24;
        }
        .warning {
            border-color: #ffc107;
            background: #fff3cd;
            color: #856404;
        }
        input, select {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 3px;
            box-sizing: border-box;
        }
        .form-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        .form-row > div {
            flex: 1;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>前端问题调试工具</h1>
    
    <div class="debug-section">
        <h3>1. 网络连接测试</h3>
        <button onclick="testConnections()">测试所有连接</button>
        <div id="connectionResult" class="result"></div>
    </div>

    <div class="debug-section">
        <h3>2. API客户端测试</h3>
        <button onclick="testApiClient()">测试API客户端</button>
        <div id="apiClientResult" class="result"></div>
    </div>

    <div class="debug-section">
        <h3>3. 供应商创建测试</h3>
        <div class="form-row">
            <div>
                <label>供应商名称:</label>
                <input type="text" id="supplierName" value="调试测试供应商">
            </div>
            <div>
                <label>联系人:</label>
                <input type="text" id="contactPerson" value="调试联系人">
            </div>
        </div>
        <div class="form-row">
            <div>
                <label>电话:</label>
                <input type="text" id="phone" value="13800138000">
            </div>
            <div>
                <label>邮箱:</label>
                <input type="email" id="email" value="debug@test.com">
            </div>
        </div>
        <div class="form-row">
            <div>
                <label>地址:</label>
                <input type="text" id="address" value="调试测试地址">
            </div>
            <div>
                <label>供应商类型:</label>
                <select id="supplierType">
                    <option value="material">物资采购</option>
                    <option value="cattle">牛只采购</option>
                    <option value="equipment">设备采购</option>
                    <option value="mixed">混合类型</option>
                </select>
            </div>
        </div>
        <button onclick="testSupplierCreation()">测试供应商创建</button>
        <button onclick="testSupplierCreationDirect()">直接API测试</button>
        <div id="supplierResult" class="result"></div>
    </div>

    <div class="debug-section">
        <h3>4. 数据格式验证</h3>
        <button onclick="validateDataFormats()">验证数据格式</button>
        <div id="dataFormatResult" class="result"></div>
    </div>

    <div class="debug-section">
        <h3>5. 错误重现测试</h3>
        <button onclick="reproduceIterableError()">重现迭代错误</button>
        <button onclick="reproduce400Error()">重现400错误</button>
        <div id="errorReproduceResult" class="result"></div>
    </div>

    <script>
        const API_BASE = '/api/v1/procurement';
        const DIRECT_API_BASE = 'http://localhost:3000/api/v1/procurement';
        const AUTH_TOKEN = 'Bearer test-token';

        function displayResult(elementId, data, type = 'success') {
            const element = document.getElementById(elementId);
            element.textContent = typeof data === 'string' ? data : JSON.stringify(data, null, 2);
            element.className = `result ${type}`;
        }

        async function makeRequest(url, options = {}) {
            try {
                console.log('发送请求:', url, options);
                
                const response = await fetch(url, {
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': AUTH_TOKEN,
                        ...options.headers
                    },
                    ...options
                });
                
                console.log('响应状态:', response.status, response.statusText);
                
                let data;
                try {
                    data = await response.json();
                } catch (e) {
                    data = await response.text();
                }
                
                console.log('响应数据:', data);
                
                return { 
                    success: response.ok, 
                    data, 
                    status: response.status,
                    statusText: response.statusText,
                    headers: Object.fromEntries(response.headers.entries())
                };
            } catch (error) {
                console.error('请求错误:', error);
                return { success: false, error: error.message, stack: error.stack };
            }
        }

        async function testConnections() {
            displayResult('connectionResult', '正在测试连接...', 'warning');
            
            const tests = [
                { name: '前端开发服务器', url: 'http://localhost:5173' },
                { name: 'API网关', url: 'http://localhost:3000/health' },
                { name: '采购服务', url: 'http://localhost:3007/health' },
                { name: '前端代理API', url: '/api/v1/procurement/health' }
            ];
            
            const results = [];
            
            for (const test of tests) {
                try {
                    const result = await makeRequest(test.url);
                    results.push({
                        name: test.name,
                        url: test.url,
                        status: result.success ? '✅ 正常' : '❌ 异常',
                        details: result.success ? result.data : result.error
                    });
                } catch (error) {
                    results.push({
                        name: test.name,
                        url: test.url,
                        status: '❌ 异常',
                        details: error.message
                    });
                }
            }
            
            displayResult('connectionResult', results, 'success');
        }

        async function testApiClient() {
            displayResult('apiClientResult', '正在测试API客户端...', 'warning');
            
            const tests = [
                {
                    name: '获取供应商列表',
                    request: () => makeRequest(`${API_BASE}/suppliers`)
                },
                {
                    name: '获取订单列表',
                    request: () => makeRequest(`${API_BASE}/orders`)
                },
                {
                    name: '获取统计数据',
                    request: () => makeRequest(`${API_BASE}/statistics`)
                }
            ];
            
            const results = [];
            
            for (const test of tests) {
                try {
                    const result = await test.request();
                    results.push({
                        name: test.name,
                        status: result.success ? '✅ 成功' : '❌ 失败',
                        data: result.success ? '数据获取正常' : result.error || result.data
                    });
                } catch (error) {
                    results.push({
                        name: test.name,
                        status: '❌ 异常',
                        data: error.message
                    });
                }
            }
            
            displayResult('apiClientResult', results, 'success');
        }

        function getSupplierFormData() {
            return {
                name: document.getElementById('supplierName').value,
                contactPerson: document.getElementById('contactPerson').value,
                phone: document.getElementById('phone').value,
                email: document.getElementById('email').value,
                address: document.getElementById('address').value,
                supplierType: document.getElementById('supplierType').value,
                rating: 5,
                creditLimit: 0
            };
        }

        async function testSupplierCreation() {
            displayResult('supplierResult', '正在测试供应商创建...', 'warning');
            
            const supplierData = getSupplierFormData();
            
            console.log('准备发送的供应商数据:', supplierData);
            
            // 验证必填字段
            const requiredFields = ['name', 'contactPerson', 'phone', 'address'];
            const missingFields = requiredFields.filter(field => !supplierData[field]);
            
            if (missingFields.length > 0) {
                displayResult('supplierResult', `缺少必填字段: ${missingFields.join(', ')}`, 'error');
                return;
            }
            
            try {
                const result = await makeRequest(`${API_BASE}/suppliers`, {
                    method: 'POST',
                    body: JSON.stringify(supplierData)
                });
                
                const resultData = {
                    success: result.success,
                    status: result.status,
                    message: result.success ? '创建成功' : '创建失败',
                    data: result.data,
                    sentData: supplierData
                };
                
                displayResult('supplierResult', resultData, result.success ? 'success' : 'error');
            } catch (error) {
                displayResult('supplierResult', {
                    error: error.message,
                    stack: error.stack,
                    sentData: supplierData
                }, 'error');
            }
        }

        async function testSupplierCreationDirect() {
            displayResult('supplierResult', '正在直接测试API...', 'warning');
            
            const supplierData = getSupplierFormData();
            
            try {
                const result = await makeRequest(`${DIRECT_API_BASE}/suppliers`, {
                    method: 'POST',
                    body: JSON.stringify(supplierData)
                });
                
                const resultData = {
                    type: '直接API调用',
                    success: result.success,
                    status: result.status,
                    message: result.success ? '创建成功' : '创建失败',
                    data: result.data,
                    sentData: supplierData
                };
                
                displayResult('supplierResult', resultData, result.success ? 'success' : 'error');
            } catch (error) {
                displayResult('supplierResult', {
                    type: '直接API调用',
                    error: error.message,
                    sentData: supplierData
                }, 'error');
            }
        }

        async function validateDataFormats() {
            displayResult('dataFormatResult', '正在验证数据格式...', 'warning');
            
            const testData = getSupplierFormData();
            
            const validations = [
                {
                    name: '数据类型检查',
                    test: () => {
                        const types = {};
                        Object.keys(testData).forEach(key => {
                            types[key] = typeof testData[key];
                        });
                        return types;
                    }
                },
                {
                    name: 'JSON序列化测试',
                    test: () => {
                        try {
                            const json = JSON.stringify(testData);
                            const parsed = JSON.parse(json);
                            return { success: true, json, parsed };
                        } catch (error) {
                            return { success: false, error: error.message };
                        }
                    }
                },
                {
                    name: '必填字段验证',
                    test: () => {
                        const required = ['name', 'contactPerson', 'phone', 'address'];
                        const missing = required.filter(field => !testData[field] || testData[field].trim() === '');
                        return { required, missing, valid: missing.length === 0 };
                    }
                }
            ];
            
            const results = {};
            validations.forEach(validation => {
                try {
                    results[validation.name] = validation.test();
                } catch (error) {
                    results[validation.name] = { error: error.message };
                }
            });
            
            displayResult('dataFormatResult', results, 'success');
        }

        async function reproduceIterableError() {
            displayResult('errorReproduceResult', '尝试重现迭代错误...', 'warning');
            
            try {
                // 模拟可能导致迭代错误的情况
                const testCases = [
                    { name: '空数据', data: null },
                    { name: '非数组数据', data: { notArray: true } },
                    { name: '字符串数据', data: 'string data' },
                    { name: '数字数据', data: 123 },
                    { name: '正常数组', data: [1, 2, 3] }
                ];
                
                const results = [];
                
                testCases.forEach(testCase => {
                    try {
                        // 尝试迭代
                        if (testCase.data && typeof testCase.data[Symbol.iterator] === 'function') {
                            const items = [...testCase.data];
                            results.push({ name: testCase.name, status: '✅ 可迭代', items });
                        } else {
                            results.push({ name: testCase.name, status: '❌ 不可迭代', type: typeof testCase.data });
                        }
                    } catch (error) {
                        results.push({ name: testCase.name, status: '❌ 错误', error: error.message });
                    }
                });
                
                displayResult('errorReproduceResult', results, 'success');
            } catch (error) {
                displayResult('errorReproduceResult', { error: error.message }, 'error');
            }
        }

        async function reproduce400Error() {
            displayResult('errorReproduceResult', '尝试重现400错误...', 'warning');
            
            const testCases = [
                { name: '缺少name', data: { contactPerson: 'test', phone: '123', address: 'test' } },
                { name: '缺少contactPerson', data: { name: 'test', phone: '123', address: 'test' } },
                { name: '缺少phone', data: { name: 'test', contactPerson: 'test', address: 'test' } },
                { name: '缺少address', data: { name: 'test', contactPerson: 'test', phone: '123' } },
                { name: '空字符串字段', data: { name: '', contactPerson: '', phone: '', address: '' } },
                { name: '正常数据', data: { name: 'test', contactPerson: 'test', phone: '123', address: 'test' } }
            ];
            
            const results = [];
            
            for (const testCase of testCases) {
                try {
                    const result = await makeRequest(`${API_BASE}/suppliers`, {
                        method: 'POST',
                        body: JSON.stringify(testCase.data)
                    });
                    
                    results.push({
                        name: testCase.name,
                        status: result.success ? '✅ 成功' : '❌ 失败',
                        statusCode: result.status,
                        message: result.data?.message || result.error,
                        sentData: testCase.data
                    });
                } catch (error) {
                    results.push({
                        name: testCase.name,
                        status: '❌ 异常',
                        error: error.message,
                        sentData: testCase.data
                    });
                }
            }
            
            displayResult('errorReproduceResult', results, 'success');
        }

        // 页面加载时自动运行基础测试
        window.onload = function() {
            console.log('调试页面加载完成');
            testConnections();
        };
    </script>
</body>
</html>