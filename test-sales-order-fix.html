<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é”€å”®è®¢å•å¿…å¡«å­—æ®µä¿®å¤æµ‹è¯•</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .warning { background-color: #fff3cd; color: #856404; }
        .info { background-color: #d1ecf1; color: #0c5460; }
        pre { background-color: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; }
        button { padding: 10px 20px; margin: 10px 0; background-color: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; }
        button:hover { background-color: #0056b3; }
        .required-fields { background-color: #fff3cd; padding: 15px; border-left: 4px solid #ffc107; }
        .test-data { background-color: #e7f3ff; padding: 15px; border-left: 4px solid #007bff; }
    </style>
</head>
<body>
    <div class="container">
        <h1>é”€å”®è®¢å•å¿…å¡«å­—æ®µä¿®å¤æµ‹è¯•</h1>
        
        <div class="test-section info">
            <h3>ğŸ¯ é—®é¢˜åˆ†æä¸ä¿®å¤æ–¹æ¡ˆ</h3>
            <p>é—®é¢˜æ ¹æºï¼šé”€å”®æœåŠ¡ä¸­å­˜åœ¨ä¸¤å¥—éªŒè¯é€»è¾‘ï¼š</p>
            <ul>
                <li><strong>æ—§ç‰ˆæœ¬</strong>: app.js - ç®€å•éªŒè¯ï¼Œè¦æ±‚ customerName å’Œ baseName</li>
                <li><strong>æ–°ç‰ˆæœ¬</strong>: TypeScript æ§åˆ¶å™¨ - å®Œæ•´çš„æƒé™æ§åˆ¶å’Œæ•°æ®éªŒè¯</li>
            </ul>
            <p><strong>ä¿®å¤æ–¹æ¡ˆ</strong>ï¼šå·²æ›´æ–° package.json ä½¿ç”¨æ–°ç‰ˆæœ¬ TypeScript æ§åˆ¶å™¨ï¼Œå¹¶ç®€åŒ–å‰ç«¯éªŒè¯é€»è¾‘ã€‚</p>
        </div>

        <div class="required-fields">
            <h3>ğŸ“‹ å¿…å¡«å­—æ®µæ¸…å•</h3>
            <ul>
                <li>âœ… <strong>customerId</strong> (customer_id): 6</li>
                <li>âŒ <strong>customerName</strong>: ç¼ºå¤± - éœ€è¦å®¢æˆ·åç§°</li>
                <li>âœ… <strong>baseId</strong> (base_id): 6</li>
                <li>âŒ <strong>baseName</strong>: ç¼ºå¤± - éœ€è¦åŸºåœ°åç§°</li>
                <li>âœ… <strong>orderDate</strong> (order_date): "2025-08-23"</li>
                <li>âœ… <strong>items</strong>: åŒ…å«1ä¸ªç‰›åªå•†å“</li>
            </ul>
        </div>

        <div class="test-data">
            <h3>ğŸ“Š æ‚¨çš„åŸå§‹æ•°æ®</h3>
            <pre id="originalData"></pre>
        </div>

        <div class="test-section">
            <h3>ğŸ”§ ä¿®å¤åçš„æ•°æ®æ ¼å¼</h3>
            <p>å‰ç«¯ç°åœ¨åªéœ€å‘é€ç®€åŒ–çš„æ•°æ®ï¼Œåç«¯ TypeScript æ§åˆ¶å™¨ä¼šè‡ªåŠ¨å¤„ç†å®¢æˆ·åç§°å’ŒåŸºåœ°åç§°ï¼š</p>
            <pre id="fixedData"></pre>
        </div>

        <div class="test-section">
            <button onclick="testGetCustomerInfo()">æµ‹è¯•è·å–å®¢æˆ·ä¿¡æ¯ (ID: 6)</button>
            <button onclick="testGetBaseInfo()">æµ‹è¯•è·å–åŸºåœ°ä¿¡æ¯ (ID: 6)</button>
            <button onclick="simulateFixedOrderCreation()">æ¨¡æ‹Ÿä¿®å¤åçš„è®¢å•åˆ›å»º</button>
        </div>

        <div id="testResults"></div>

        <div class="test-section warning">
            <h3>âš ï¸ æ³¨æ„äº‹é¡¹</h3>
            <ul>
                <li>å·²æ›´æ–° package.json ä½¿ç”¨ TypeScript æ§åˆ¶å™¨ï¼ˆsrc/app.tsï¼‰</li>
                <li>å·²ç®€åŒ–å‰ç«¯éªŒè¯é€»è¾‘ï¼Œç§»é™¤äº†è·å–å®¢æˆ·å’ŒåŸºåœ°åç§°çš„å¤æ‚é€»è¾‘</li>
                <li>æ–°ç‰ˆæœ¬ TypeScript æ§åˆ¶å™¨ä¼šè‡ªåŠ¨å¤„ç† customerName å’Œ baseName</li>
                <li>å¯åŠ¨å‘½ä»¤: npm run devï¼ˆä½¿ç”¨ ts-nodeï¼‰</li>
                <li>æ—§ç‰ˆæœ¬ app.js å·²æ·»åŠ å¼ƒç”¨è­¦å‘Š</li>
            </ul>
        </div>
    </div>

    <script>
        // æ‚¨çš„åŸå§‹è®¢å•æ•°æ®
        const originalOrderData = {
            "customer_id": 6,
            "base_id": 6,
            "total_amount": 18000,
            "order_date": "2025-08-23",
            "delivery_date": "2025-08-24",
            "payment_method": "bank_transfer",
            "contract_number": null,
            "remark": "",
            "items": [
                {
                    "itemType": "cattle",
                    "quantity": 1,
                    "unit_price": 18000,
                    "notes": null,
                    "cattle_id": 4,
                    "ear_tag": "003",
                    "breed": "è¥¿é—¨å¡”å°”",
                    "weight": 357,
                    "quality_grade": null
                }
            ]
        };

        // ä¿®å¤åçš„æ•°æ®ç¤ºä¾‹ï¼ˆç®€åŒ–ç‰ˆï¼‰
        const fixedOrderData = {
            ...originalOrderData
            // TypeScript æ§åˆ¶å™¨ä¼šè‡ªåŠ¨å¤„ç†ï¼š
            // - customerName: ä¼šä»æ•°æ®åº“è·å–
            // - baseName: ä¼šä»æ•°æ®åº“è·å–
            // - æƒé™éªŒè¯ï¼šåŸºäºç”¨æˆ·è§’è‰²è‡ªåŠ¨å¤„ç†
        };

        // æ˜¾ç¤ºæ•°æ®
        document.getElementById('originalData').textContent = JSON.stringify(originalOrderData, null, 2);
        document.getElementById('fixedData').textContent = JSON.stringify(fixedOrderData, null, 2);

        function showResult(message, type = 'info') {
            const resultsDiv = document.getElementById('testResults');
            const resultElement = document.createElement('div');
            resultElement.className = `test-section ${type}`;
            resultElement.innerHTML = `<h4>æµ‹è¯•ç»“æœ</h4><p>${message}</p><p><small>æ—¶é—´: ${new Date().toLocaleString()}</small></p>`;
            resultsDiv.appendChild(resultElement);
        }

        async function testGetCustomerInfo() {
            try {
                showResult('æ­£åœ¨æµ‹è¯•è·å–å®¢æˆ·ä¿¡æ¯...', 'info');
                
                const response = await fetch('/api/v1/sales/customers/6', {
                    headers: {
                        'Authorization': localStorage.getItem('token') ? `Bearer ${localStorage.getItem('token')}` : ''
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    showResult(`âœ… å®¢æˆ·ä¿¡æ¯è·å–æˆåŠŸ: ${JSON.stringify(data, null, 2)}`, 'success');
                } else {
                    showResult(`âŒ å®¢æˆ·ä¿¡æ¯è·å–å¤±è´¥: ${response.status} ${response.statusText}`, 'error');
                }
            } catch (error) {
                showResult(`âŒ å®¢æˆ·ä¿¡æ¯è·å–å¼‚å¸¸: ${error.message}`, 'error');
            }
        }

        async function testGetBaseInfo() {
            try {
                showResult('æ­£åœ¨æµ‹è¯•è·å–åŸºåœ°ä¿¡æ¯...', 'info');
                
                const response = await fetch('/api/v1/base/bases/6', {
                    headers: {
                        'Authorization': localStorage.getItem('token') ? `Bearer ${localStorage.getItem('token')}` : ''
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    showResult(`âœ… åŸºåœ°ä¿¡æ¯è·å–æˆåŠŸ: ${JSON.stringify(data, null, 2)}`, 'success');
                } else {
                    showResult(`âŒ åŸºåœ°ä¿¡æ¯è·å–å¤±è´¥: ${response.status} ${response.statusText}`, 'error');
                }
            } catch (error) {
                showResult(`âŒ åŸºåœ°ä¿¡æ¯è·å–å¼‚å¸¸: ${error.message}`, 'error');
            }
        }

        async function simulateFixedOrderCreation() {
            try {
                showResult('æ­£åœ¨æ¨¡æ‹Ÿä¿®å¤åçš„è®¢å•åˆ›å»º...', 'info');
                
                // æ¨¡æ‹Ÿè·å–å®¢æˆ·åç§°
                let customerName = '';
                try {
                    const customerResponse = await fetch('/api/v1/sales/customers/6', {
                        headers: {
                            'Authorization': localStorage.getItem('token') ? `Bearer ${localStorage.getItem('token')}` : ''
                        }
                    });
                    if (customerResponse.ok) {
                        const customerData = await customerResponse.json();
                        customerName = customerData.data?.name || customerData.name || 'å®¢æˆ·6';
                    }
                } catch (error) {
                    customerName = 'å®¢æˆ·6'; // é»˜è®¤å€¼
                }

                // æ¨¡æ‹Ÿè·å–åŸºåœ°åç§°
                let baseName = '';
                try {
                    const baseResponse = await fetch('/api/v1/base/bases/6', {
                        headers: {
                            'Authorization': localStorage.getItem('token') ? `Bearer ${localStorage.getItem('token')}` : ''
                        }
                    });
                    if (baseResponse.ok) {
                        const baseData = await baseResponse.json();
                        baseName = baseData.data?.name || baseData.name || 'åŸºåœ°6';
                    }
                } catch (error) {
                    baseName = 'åŸºåœ°6'; // é»˜è®¤å€¼
                }

                // æ„å»ºå®Œæ•´çš„è®¢å•æ•°æ®
                const completeOrderData = {
                    ...originalOrderData,
                    customerId: originalOrderData.customer_id,
                    customerName: customerName,
                    baseId: originalOrderData.base_id,
                    baseName: baseName,
                    orderDate: originalOrderData.order_date
                };

                showResult(`ğŸ“Š ä¿®å¤åçš„å®Œæ•´è®¢å•æ•°æ®:<br><pre>${JSON.stringify(completeOrderData, null, 2)}</pre>`, 'success');

                // æ¨¡æ‹Ÿå‘é€è¯·æ±‚
                const response = await fetch('/api/v1/sales/orders', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': localStorage.getItem('token') ? `Bearer ${localStorage.getItem('token')}` : ''
                    },
                    body: JSON.stringify(completeOrderData)
                });

                if (response.ok) {
                    const result = await response.json();
                    showResult(`âœ… è®¢å•åˆ›å»ºæˆåŠŸ! è®¢å•ID: ${result.data?.order?.id || result.data?.id || 'N/A'}`, 'success');
                } else {
                    const errorData = await response.text();
                    showResult(`âŒ è®¢å•åˆ›å»ºå¤±è´¥: ${response.status} ${response.statusText}<br>é”™è¯¯è¯¦æƒ…: ${errorData}`, 'error');
                }

            } catch (error) {
                showResult(`âŒ è®¢å•åˆ›å»ºå¼‚å¸¸: ${error.message}`, 'error');
            }
        }
    </script>
</body>
</html>