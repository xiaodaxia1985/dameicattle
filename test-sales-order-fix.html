<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>销售订单必填字段修复测试</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .warning { background-color: #fff3cd; color: #856404; }
        .info { background-color: #d1ecf1; color: #0c5460; }
        pre { background-color: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; }
        button { padding: 10px 20px; margin: 10px 0; background-color: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; }
        button:hover { background-color: #0056b3; }
        .required-fields { background-color: #fff3cd; padding: 15px; border-left: 4px solid #ffc107; }
        .test-data { background-color: #e7f3ff; padding: 15px; border-left: 4px solid #007bff; }
    </style>
</head>
<body>
    <div class="container">
        <h1>销售订单必填字段修复测试</h1>
        
        <div class="test-section info">
            <h3>🎯 问题分析与修复方案</h3>
            <p>问题根源：销售服务中存在两套验证逻辑：</p>
            <ul>
                <li><strong>旧版本</strong>: app.js - 简单验证，要求 customerName 和 baseName</li>
                <li><strong>新版本</strong>: TypeScript 控制器 - 完整的权限控制和数据验证</li>
            </ul>
            <p><strong>修复方案</strong>：已更新 package.json 使用新版本 TypeScript 控制器，并简化前端验证逻辑。</p>
        </div>

        <div class="required-fields">
            <h3>📋 必填字段清单</h3>
            <ul>
                <li>✅ <strong>customerId</strong> (customer_id): 6</li>
                <li>❌ <strong>customerName</strong>: 缺失 - 需要客户名称</li>
                <li>✅ <strong>baseId</strong> (base_id): 6</li>
                <li>❌ <strong>baseName</strong>: 缺失 - 需要基地名称</li>
                <li>✅ <strong>orderDate</strong> (order_date): "2025-08-23"</li>
                <li>✅ <strong>items</strong>: 包含1个牛只商品</li>
            </ul>
        </div>

        <div class="test-data">
            <h3>📊 您的原始数据</h3>
            <pre id="originalData"></pre>
        </div>

        <div class="test-section">
            <h3>🔧 修复后的数据格式</h3>
            <p>前端现在只需发送简化的数据，后端 TypeScript 控制器会自动处理客户名称和基地名称：</p>
            <pre id="fixedData"></pre>
        </div>

        <div class="test-section">
            <button onclick="testGetCustomerInfo()">测试获取客户信息 (ID: 6)</button>
            <button onclick="testGetBaseInfo()">测试获取基地信息 (ID: 6)</button>
            <button onclick="simulateFixedOrderCreation()">模拟修复后的订单创建</button>
        </div>

        <div id="testResults"></div>

        <div class="test-section warning">
            <h3>⚠️ 注意事项</h3>
            <ul>
                <li>已更新 package.json 使用 TypeScript 控制器（src/app.ts）</li>
                <li>已简化前端验证逻辑，移除了获取客户和基地名称的复杂逻辑</li>
                <li>新版本 TypeScript 控制器会自动处理 customerName 和 baseName</li>
                <li>启动命令: npm run dev（使用 ts-node）</li>
                <li>旧版本 app.js 已添加弃用警告</li>
            </ul>
        </div>
    </div>

    <script>
        // 您的原始订单数据
        const originalOrderData = {
            "customer_id": 6,
            "base_id": 6,
            "total_amount": 18000,
            "order_date": "2025-08-23",
            "delivery_date": "2025-08-24",
            "payment_method": "bank_transfer",
            "contract_number": null,
            "remark": "",
            "items": [
                {
                    "itemType": "cattle",
                    "quantity": 1,
                    "unit_price": 18000,
                    "notes": null,
                    "cattle_id": 4,
                    "ear_tag": "003",
                    "breed": "西门塔尔",
                    "weight": 357,
                    "quality_grade": null
                }
            ]
        };

        // 修复后的数据示例（简化版）
        const fixedOrderData = {
            ...originalOrderData
            // TypeScript 控制器会自动处理：
            // - customerName: 会从数据库获取
            // - baseName: 会从数据库获取
            // - 权限验证：基于用户角色自动处理
        };

        // 显示数据
        document.getElementById('originalData').textContent = JSON.stringify(originalOrderData, null, 2);
        document.getElementById('fixedData').textContent = JSON.stringify(fixedOrderData, null, 2);

        function showResult(message, type = 'info') {
            const resultsDiv = document.getElementById('testResults');
            const resultElement = document.createElement('div');
            resultElement.className = `test-section ${type}`;
            resultElement.innerHTML = `<h4>测试结果</h4><p>${message}</p><p><small>时间: ${new Date().toLocaleString()}</small></p>`;
            resultsDiv.appendChild(resultElement);
        }

        async function testGetCustomerInfo() {
            try {
                showResult('正在测试获取客户信息...', 'info');
                
                const response = await fetch('/api/v1/sales/customers/6', {
                    headers: {
                        'Authorization': localStorage.getItem('token') ? `Bearer ${localStorage.getItem('token')}` : ''
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    showResult(`✅ 客户信息获取成功: ${JSON.stringify(data, null, 2)}`, 'success');
                } else {
                    showResult(`❌ 客户信息获取失败: ${response.status} ${response.statusText}`, 'error');
                }
            } catch (error) {
                showResult(`❌ 客户信息获取异常: ${error.message}`, 'error');
            }
        }

        async function testGetBaseInfo() {
            try {
                showResult('正在测试获取基地信息...', 'info');
                
                const response = await fetch('/api/v1/base/bases/6', {
                    headers: {
                        'Authorization': localStorage.getItem('token') ? `Bearer ${localStorage.getItem('token')}` : ''
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    showResult(`✅ 基地信息获取成功: ${JSON.stringify(data, null, 2)}`, 'success');
                } else {
                    showResult(`❌ 基地信息获取失败: ${response.status} ${response.statusText}`, 'error');
                }
            } catch (error) {
                showResult(`❌ 基地信息获取异常: ${error.message}`, 'error');
            }
        }

        async function simulateFixedOrderCreation() {
            try {
                showResult('正在模拟修复后的订单创建...', 'info');
                
                // 模拟获取客户名称
                let customerName = '';
                try {
                    const customerResponse = await fetch('/api/v1/sales/customers/6', {
                        headers: {
                            'Authorization': localStorage.getItem('token') ? `Bearer ${localStorage.getItem('token')}` : ''
                        }
                    });
                    if (customerResponse.ok) {
                        const customerData = await customerResponse.json();
                        customerName = customerData.data?.name || customerData.name || '客户6';
                    }
                } catch (error) {
                    customerName = '客户6'; // 默认值
                }

                // 模拟获取基地名称
                let baseName = '';
                try {
                    const baseResponse = await fetch('/api/v1/base/bases/6', {
                        headers: {
                            'Authorization': localStorage.getItem('token') ? `Bearer ${localStorage.getItem('token')}` : ''
                        }
                    });
                    if (baseResponse.ok) {
                        const baseData = await baseResponse.json();
                        baseName = baseData.data?.name || baseData.name || '基地6';
                    }
                } catch (error) {
                    baseName = '基地6'; // 默认值
                }

                // 构建完整的订单数据
                const completeOrderData = {
                    ...originalOrderData,
                    customerId: originalOrderData.customer_id,
                    customerName: customerName,
                    baseId: originalOrderData.base_id,
                    baseName: baseName,
                    orderDate: originalOrderData.order_date
                };

                showResult(`📊 修复后的完整订单数据:<br><pre>${JSON.stringify(completeOrderData, null, 2)}</pre>`, 'success');

                // 模拟发送请求
                const response = await fetch('/api/v1/sales/orders', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': localStorage.getItem('token') ? `Bearer ${localStorage.getItem('token')}` : ''
                    },
                    body: JSON.stringify(completeOrderData)
                });

                if (response.ok) {
                    const result = await response.json();
                    showResult(`✅ 订单创建成功! 订单ID: ${result.data?.order?.id || result.data?.id || 'N/A'}`, 'success');
                } else {
                    const errorData = await response.text();
                    showResult(`❌ 订单创建失败: ${response.status} ${response.statusText}<br>错误详情: ${errorData}`, 'error');
                }

            } catch (error) {
                showResult(`❌ 订单创建异常: ${error.message}`, 'error');
            }
        }
    </script>
</body>
</html>