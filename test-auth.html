<!DOCTYPE html>
<html>
<head>
    <title>认证状态测试</title>
</head>
<body>
    <h1>认证状态测试</h1>
    <div id="result"></div>
    
    <script>
        async function testAuth() {
            const result = document.getElementById('result');
            
            // 检查localStorage中的认证信息
            const token = localStorage.getItem('token');
            const user = localStorage.getItem('user');
            const permissions = localStorage.getItem('permissions');
            
            result.innerHTML += '<h2>本地存储状态:</h2>';
            result.innerHTML += '<p>Token存在: ' + (!!token) + '</p>';
            result.innerHTML += '<p>用户信息存在: ' + (!!user) + '</p>';
            result.innerHTML += '<p>权限信息存在: ' + (!!permissions) + '</p>';
            
            if (token) {
                result.innerHTML += '<p>Token长度: ' + token.length + '</p>';
                result.innerHTML += '<p>Token前20个字符: ' + token.substring(0, 20) + '...</p>';
            }
            
            if (user) {
                try {
                    const userData = JSON.parse(user);
                    result.innerHTML += '<p>用户ID: ' + userData.id + '</p>';
                    result.innerHTML += '<p>用户名: ' + userData.username + '</p>';
                    result.innerHTML += '<p>用户状态: ' + userData.status + '</p>';
                } catch (e) {
                    result.innerHTML += '<p>用户信息解析失败: ' + e.message + '</p>';
                }
            }
            
            // 测试API调用
            if (token) {
                result.innerHTML += '<h2>API测试:</h2>';
                
                try {
                    // 测试auth API
                    const authResponse = await fetch('/api/v1/auth/profile', {
                        headers: {
                            'Authorization': 'Bearer ' + token
                        }
                    });
                    
                    result.innerHTML += '<p>Auth API状态: ' + authResponse.status + '</p>';
                    
                    if (authResponse.ok) {
                        const authData = await authResponse.json();
                        result.innerHTML += '<p>Auth API响应: ' + JSON.stringify(authData, null, 2) + '</p>';
                    } else {
                        const authError = await authResponse.text();
                        result.innerHTML += '<p>Auth API错误: ' + authError + '</p>';
                    }
                } catch (e) {
                    result.innerHTML += '<p>Auth API调用失败: ' + e.message + '</p>';
                }
                
                try {
                    // 测试feeding API
                    const feedingResponse = await fetch('/api/v1/feeding/formulas', {
                        headers: {
                            'Authorization': 'Bearer ' + token
                        }
                    });
                    
                    result.innerHTML += '<p>Feeding API状态: ' + feedingResponse.status + '</p>';
                    
                    if (feedingResponse.ok) {
                        const feedingData = await feedingResponse.json();
                        result.innerHTML += '<p>Feeding API响应: ' + JSON.stringify(feedingData, null, 2) + '</p>';
                    } else {
                        const feedingError = await feedingResponse.text();
                        result.innerHTML += '<p>Feeding API错误: ' + feedingError + '</p>';
                    }
                } catch (e) {
                    result.innerHTML += '<p>Feeding API调用失败: ' + e.message + '</p>';
                }
            }
        }
        
        // 页面加载后执行测试
        window.onload = testAuth;
    </script>
</body>
</html>