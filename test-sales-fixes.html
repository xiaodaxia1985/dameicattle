<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é”€å”®æ¨¡å—ä¿®å¤éªŒè¯</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f7fa;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .test-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.1);
        }
        .test-section h3 {
            color: #409eff;
            margin-top: 0;
        }
        .test-button {
            background: #409eff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover {
            background: #66b1ff;
        }
        .test-button.success {
            background: #67c23a;
        }
        .test-button.danger {
            background: #f56c6c;
        }
        .result {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin-top: 10px;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
        }
        .success {
            border-left: 4px solid #67c23a;
        }
        .error {
            border-left: 4px solid #f56c6c;
            color: #f56c6c;
        }
        .warning {
            border-left: 4px solid #e6a23c;
            color: #e6a23c;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ é”€å”®æ¨¡å—ä¿®å¤éªŒè¯å·¥å…·</h1>
        
        <div class="test-section">
            <h3>1. åŸºåœ°åˆ—è¡¨è·å–æµ‹è¯•</h3>
            <p>æµ‹è¯•åŸºåœ°åˆ—è¡¨æ˜¯å¦èƒ½æ­£ç¡®è·å–æ•°æ®ï¼ˆä¿®å¤getBases APIè°ƒç”¨ï¼‰</p>
            <button class="test-button" onclick="testGetBases()">æµ‹è¯•åŸºåœ°åˆ—è¡¨è·å–</button>
            <div id="bases-result" class="result"></div>
        </div>

        <div class="test-section">
            <h3>2. ç‰›åªåˆ—è¡¨è·å–æµ‹è¯•</h3>
            <p>æµ‹è¯•ç‰›åªåˆ—è¡¨æ˜¯å¦èƒ½æ­£ç¡®è·å–æ•°æ®</p>
            <button class="test-button" onclick="testGetCattle()">æµ‹è¯•ç‰›åªåˆ—è¡¨è·å–</button>
            <div id="cattle-result" class="result"></div>
        </div>

        <div class="test-section">
            <h3>3. å®¢æˆ·æ›´æ–°æµ‹è¯•</h3>
            <p>æµ‹è¯•å®¢æˆ·æ›´æ–°æ˜¯å¦èƒ½é¿å…"admin"å­—ç¬¦ä¸²é”™è¯¯</p>
            <button class="test-button" onclick="testCustomerUpdate()">æµ‹è¯•å®¢æˆ·æ›´æ–°</button>
            <div id="customer-update-result" class="result"></div>
        </div>

        <div class="test-section">
            <h3>4. è®¢å•åˆ›å»ºæµ‹è¯•</h3>
            <p>æµ‹è¯•è®¢å•åˆ›å»ºæ˜¯å¦èƒ½æ­£ç¡®å¤„ç†æ•°æ®æ ¼å¼</p>
            <button class="test-button" onclick="testOrderCreation()">æµ‹è¯•è®¢å•åˆ›å»º</button>
            <div id="order-create-result" class="result"></div>
        </div>

        <div class="test-section">
            <h3>5. å®Œæ•´æµç¨‹æµ‹è¯•</h3>
            <p>æµ‹è¯•å®Œæ•´çš„åˆ›å»ºè®¢å•æµç¨‹</p>
            <button class="test-button success" onclick="testCompleteFlow()">æµ‹è¯•å®Œæ•´æµç¨‹</button>
            <div id="complete-flow-result" class="result"></div>
        </div>
    </div>

    <script>
        // æµ‹è¯•åŸºåœ°åˆ—è¡¨è·å–
        async function testGetBases() {
            const resultDiv = document.getElementById('bases-result');
            resultDiv.innerHTML = 'ğŸ”„ æ­£åœ¨æµ‹è¯•åŸºåœ°åˆ—è¡¨è·å–...';
            
            try {
                console.log('ğŸ” æµ‹è¯•åŸºåœ°åˆ—è¡¨API...');
                
                // ç›´æ¥è°ƒç”¨åŸºåœ°æœåŠ¡API
                const response = await fetch('/api/v1/base/bases');
                const data = await response.json();
                
                console.log('ğŸ“¥ åŸºåœ°APIå“åº”:', data);
                
                let basesData = [];
                
                // å¤„ç†å“åº”æ•°æ®
                if (data.success && data.data) {
                    const apiData = data.data;
                    if (Array.isArray(apiData.bases)) {
                        basesData = apiData.bases;
                    } else if (Array.isArray(apiData.items)) {
                        basesData = apiData.items;
                    } else if (Array.isArray(apiData)) {
                        basesData = apiData;
                    }
                } else if (Array.isArray(data)) {
                    basesData = data;
                }
                
                if (basesData.length > 0) {
                    resultDiv.innerHTML = `âœ… åŸºåœ°åˆ—è¡¨è·å–æˆåŠŸï¼

åŸºåœ°æ•°é‡: ${basesData.length}
å“åº”çŠ¶æ€: ${response.status}

åŸºåœ°åˆ—è¡¨:
${JSON.stringify(basesData, null, 2)}

ç¬¬ä¸€ä¸ªåŸºåœ°:
- ID: ${basesData[0]?.id || 'æœªçŸ¥'}
- åç§°: ${basesData[0]?.name || 'æœªçŸ¥'}
- åœ°å€: ${basesData[0]?.address || 'æœªçŸ¥'}`;
                    resultDiv.className = 'result success';
                } else {
                    resultDiv.innerHTML = `âš ï¸ åŸºåœ°åˆ—è¡¨ä¸ºç©º

å“åº”æ•°æ®:
${JSON.stringify(data, null, 2)}

å¯èƒ½åŸå› :
1. æ•°æ®åº“ä¸­æ²¡æœ‰åŸºåœ°æ•°æ®
2. ç”¨æˆ·æƒé™ä¸è¶³
3. åŸºåœ°æœåŠ¡æœªæ­£å¸¸è¿è¡Œ`;
                    resultDiv.className = 'result warning';
                }
                
            } catch (error) {
                console.error('âŒ åŸºåœ°åˆ—è¡¨è·å–å¤±è´¥:', error);
                resultDiv.innerHTML = `âŒ åŸºåœ°åˆ—è¡¨è·å–å¤±è´¥:
${error.message}

é”™è¯¯è¯¦æƒ…:
${JSON.stringify(error, null, 2)}

å¯èƒ½åŸå› :
1. åŸºåœ°æœåŠ¡æœªå¯åŠ¨ (ç«¯å£3002)
2. APIç½‘å…³é…ç½®é—®é¢˜
3. ç½‘ç»œè¿æ¥é—®é¢˜`;
                resultDiv.className = 'result error';
            }
        }

        // æµ‹è¯•ç‰›åªåˆ—è¡¨è·å–
        async function testGetCattle() {
            const resultDiv = document.getElementById('cattle-result');
            resultDiv.innerHTML = 'ğŸ”„ æ­£åœ¨æµ‹è¯•ç‰›åªåˆ—è¡¨è·å–...';
            
            try {
                console.log('ğŸ” æµ‹è¯•ç‰›åªåˆ—è¡¨API...');
                
                // è°ƒç”¨é”€å”®æœåŠ¡çš„ç‰›åªAPI
                const response = await fetch('/api/v1/sales/cattle?base_id=1&limit=5');
                const data = await response.json();
                
                console.log('ğŸ“¥ ç‰›åªAPIå“åº”:', data);
                
                let cattleData = [];
                
                // å¤„ç†å“åº”æ•°æ®
                if (data.success && data.data) {
                    const apiData = data.data;
                    if (Array.isArray(apiData.cattle)) {
                        cattleData = apiData.cattle;
                    } else if (Array.isArray(apiData.items)) {
                        cattleData = apiData.items;
                    } else if (Array.isArray(apiData)) {
                        cattleData = apiData;
                    }
                } else if (Array.isArray(data)) {
                    cattleData = data;
                }
                
                if (cattleData.length > 0) {
                    resultDiv.innerHTML = `âœ… ç‰›åªåˆ—è¡¨è·å–æˆåŠŸï¼

ç‰›åªæ•°é‡: ${cattleData.length}
å“åº”çŠ¶æ€: ${response.status}

ç¬¬ä¸€å¤´ç‰›åª:
- ID: ${cattleData[0]?.id || 'æœªçŸ¥'}
- è€³æ ‡: ${cattleData[0]?.ear_tag || 'æœªçŸ¥'}
- å“ç§: ${cattleData[0]?.breed || 'æœªçŸ¥'}
- é‡é‡: ${cattleData[0]?.weight || 'æœªçŸ¥'}kg`;
                    resultDiv.className = 'result success';
                } else {
                    resultDiv.innerHTML = `âš ï¸ ç‰›åªåˆ—è¡¨ä¸ºç©º

å“åº”æ•°æ®:
${JSON.stringify(data, null, 2)}

å¯èƒ½åŸå› :
1. æŒ‡å®šåŸºåœ°æ²¡æœ‰ç‰›åªæ•°æ®
2. ç‰›åªæœåŠ¡æœªæ­£å¸¸è¿è¡Œ
3. æ•°æ®æƒé™é—®é¢˜`;
                    resultDiv.className = 'result warning';
                }
                
            } catch (error) {
                console.error('âŒ ç‰›åªåˆ—è¡¨è·å–å¤±è´¥:', error);
                resultDiv.innerHTML = `âŒ ç‰›åªåˆ—è¡¨è·å–å¤±è´¥:
${error.message}

å¯èƒ½åŸå› :
1. é”€å”®æœåŠ¡æœªå¯åŠ¨ (ç«¯å£3008)
2. ç‰›åªæœåŠ¡æœªå¯åŠ¨ (ç«¯å£3003)
3. APIè·¯ç”±é…ç½®é—®é¢˜`;
                resultDiv.className = 'result error';
            }
        }

        // æµ‹è¯•å®¢æˆ·æ›´æ–°
        async function testCustomerUpdate() {
            const resultDiv = document.getElementById('customer-update-result');
            resultDiv.innerHTML = 'ğŸ”„ æ­£åœ¨æµ‹è¯•å®¢æˆ·æ›´æ–°...';
            
            try {
                console.log('ğŸ” æµ‹è¯•å®¢æˆ·æ›´æ–°API...');
                
                // é¦–å…ˆè·å–å®¢æˆ·åˆ—è¡¨
                const listResponse = await fetch('/api/v1/sales/customers?limit=1');
                const listData = await listResponse.json();
                
                console.log('ğŸ“¥ å®¢æˆ·åˆ—è¡¨å“åº”:', listData);
                
                let customers = [];
                if (listData.success && listData.data) {
                    const apiData = listData.data;
                    if (Array.isArray(apiData.customers)) {
                        customers = apiData.customers;
                    } else if (Array.isArray(apiData.items)) {
                        customers = apiData.items;
                    }
                }
                
                if (customers.length === 0) {
                    resultDiv.innerHTML = `âš ï¸ æ²¡æœ‰æ‰¾åˆ°å®¢æˆ·æ•°æ®è¿›è¡Œæµ‹è¯•

è¯·å…ˆåˆ›å»ºä¸€äº›å®¢æˆ·æ•°æ®ï¼Œç„¶åå†æµ‹è¯•æ›´æ–°åŠŸèƒ½ã€‚`;
                    resultDiv.className = 'result warning';
                    return;
                }
                
                const testCustomer = customers[0];
                console.log('ğŸ¯ æµ‹è¯•å®¢æˆ·:', testCustomer);
                
                // å‡†å¤‡æ›´æ–°æ•°æ®ï¼ˆæ¨¡æ‹Ÿå¯èƒ½å¯¼è‡´é—®é¢˜çš„æ•°æ®ï¼‰
                const updateData = {
                    name: testCustomer.name,
                    contact_person: testCustomer.contact_person,
                    phone: testCustomer.phone,
                    email: testCustomer.email,
                    address: testCustomer.address,
                    credit_rating: 4,
                    credit_limit: 50000,
                    customer_type: testCustomer.customer_type || 'individual',
                    status: 'active'
                };
                
                console.log('ğŸ“Š æ›´æ–°æ•°æ®:', updateData);
                
                // è°ƒç”¨æ›´æ–°API
                const updateResponse = await fetch(`/api/v1/sales/customers/${testCustomer.id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updateData)
                });
                
                const updateResult = await updateResponse.json();
                console.log('ğŸ“¥ æ›´æ–°å“åº”:', updateResult);
                
                if (updateResponse.ok) {
                    resultDiv.innerHTML = `âœ… å®¢æˆ·æ›´æ–°æµ‹è¯•æˆåŠŸï¼

æµ‹è¯•å®¢æˆ·ID: ${testCustomer.id}
å“åº”çŠ¶æ€: ${updateResponse.status}

æ›´æ–°å‰æ•°æ®:
- ä¿¡ç”¨è¯„çº§: ${testCustomer.credit_rating}
- ä¿¡ç”¨é¢åº¦: ${testCustomer.credit_limit}

æ›´æ–°åæ•°æ®:
- ä¿¡ç”¨è¯„çº§: ${updateResult.credit_rating || updateResult.data?.credit_rating}
- ä¿¡ç”¨é¢åº¦: ${updateResult.credit_limit || updateResult.data?.credit_limit}

âœ… æ²¡æœ‰å‡ºç°"admin"å­—ç¬¦ä¸²é”™è¯¯ï¼`;
                    resultDiv.className = 'result success';
                } else {
                    resultDiv.innerHTML = `âŒ å®¢æˆ·æ›´æ–°å¤±è´¥:

é”™è¯¯çŠ¶æ€: ${updateResponse.status}
é”™è¯¯ä¿¡æ¯: ${updateResult.message || 'æœªçŸ¥é”™è¯¯'}

å“åº”è¯¦æƒ…:
${JSON.stringify(updateResult, null, 2)}`;
                    resultDiv.className = 'result error';
                }
                
            } catch (error) {
                console.error('âŒ å®¢æˆ·æ›´æ–°æµ‹è¯•å¤±è´¥:', error);
                resultDiv.innerHTML = `âŒ å®¢æˆ·æ›´æ–°æµ‹è¯•å¤±è´¥:
${error.message}

é”™è¯¯è¯¦æƒ…:
${JSON.stringify(error, null, 2)}`;
                resultDiv.className = 'result error';
            }
        }

        // æµ‹è¯•è®¢å•åˆ›å»º
        async function testOrderCreation() {
            const resultDiv = document.getElementById('order-create-result');
            resultDiv.innerHTML = 'ğŸ”„ æ­£åœ¨æµ‹è¯•è®¢å•åˆ›å»º...';
            
            try {
                console.log('ğŸ” æµ‹è¯•è®¢å•åˆ›å»ºAPI...');
                
                // å‡†å¤‡æµ‹è¯•æ•°æ®
                const orderData = {
                    customer_id: 1,
                    base_id: 1,
                    cattle_ids: [1, 2],
                    total_amount: 50000,
                    order_date: new Date().toISOString().split('T')[0],
                    expected_delivery_date: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                    notes: 'æµ‹è¯•è®¢å•åˆ›å»º'
                };
                
                console.log('ğŸ“Š è®¢å•æ•°æ®:', orderData);
                
                // è°ƒç”¨åˆ›å»ºAPI
                const response = await fetch('/api/v1/sales/orders', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(orderData)
                });
                
                const result = await response.json();
                console.log('ğŸ“¥ åˆ›å»ºå“åº”:', result);
                
                if (response.ok) {
                    resultDiv.innerHTML = `âœ… è®¢å•åˆ›å»ºæµ‹è¯•æˆåŠŸï¼

å“åº”çŠ¶æ€: ${response.status}
è®¢å•å·: ${result.order_number || result.data?.order_number || 'æœªçŸ¥'}
è®¢å•ID: ${result.id || result.data?.id || 'æœªçŸ¥'}

åˆ›å»ºçš„è®¢å•ä¿¡æ¯:
${JSON.stringify(result, null, 2)}

âœ… æ²¡æœ‰å‡ºç°400é”™è¯¯ï¼`;
                    resultDiv.className = 'result success';
                } else {
                    resultDiv.innerHTML = `âŒ è®¢å•åˆ›å»ºå¤±è´¥:

é”™è¯¯çŠ¶æ€: ${response.status}
é”™è¯¯ä¿¡æ¯: ${result.message || 'æœªçŸ¥é”™è¯¯'}

å¯èƒ½åŸå› :
1. å®¢æˆ·IDä¸å­˜åœ¨ (customer_id: ${orderData.customer_id})
2. åŸºåœ°IDä¸å­˜åœ¨ (base_id: ${orderData.base_id})
3. ç‰›åªIDä¸å­˜åœ¨ (cattle_ids: ${JSON.stringify(orderData.cattle_ids)})
4. ç”¨æˆ·æƒé™ä¸è¶³

å“åº”è¯¦æƒ…:
${JSON.stringify(result, null, 2)}`;
                    resultDiv.className = 'result error';
                }
                
            } catch (error) {
                console.error('âŒ è®¢å•åˆ›å»ºæµ‹è¯•å¤±è´¥:', error);
                resultDiv.innerHTML = `âŒ è®¢å•åˆ›å»ºæµ‹è¯•å¤±è´¥:
${error.message}

é”™è¯¯è¯¦æƒ…:
${JSON.stringify(error, null, 2)}`;
                resultDiv.className = 'result error';
            }
        }

        // æµ‹è¯•å®Œæ•´æµç¨‹
        async function testCompleteFlow() {
            const resultDiv = document.getElementById('complete-flow-result');
            resultDiv.innerHTML = 'ğŸ”„ æ­£åœ¨æµ‹è¯•å®Œæ•´æµç¨‹...';
            
            try {
                let report = 'ğŸ”„ å¼€å§‹å®Œæ•´æµç¨‹æµ‹è¯•...\n\n';
                
                // 1. æµ‹è¯•åŸºåœ°åˆ—è¡¨
                report += '1ï¸âƒ£ æµ‹è¯•åŸºåœ°åˆ—è¡¨è·å–...\n';
                const basesResponse = await fetch('/api/v1/base/bases');
                const basesData = await basesResponse.json();
                
                let bases = [];
                if (basesData.success && basesData.data) {
                    bases = basesData.data.bases || basesData.data.items || basesData.data;
                } else if (Array.isArray(basesData)) {
                    bases = basesData;
                }
                
                if (bases.length > 0) {
                    report += `âœ… åŸºåœ°åˆ—è¡¨è·å–æˆåŠŸ (${bases.length}ä¸ªåŸºåœ°)\n`;
                } else {
                    report += `âš ï¸ åŸºåœ°åˆ—è¡¨ä¸ºç©º\n`;
                }
                
                // 2. æµ‹è¯•å®¢æˆ·åˆ—è¡¨
                report += '\n2ï¸âƒ£ æµ‹è¯•å®¢æˆ·åˆ—è¡¨è·å–...\n';
                const customersResponse = await fetch('/api/v1/sales/customers?limit=5');
                const customersData = await customersResponse.json();
                
                let customers = [];
                if (customersData.success && customersData.data) {
                    customers = customersData.data.customers || customersData.data.items || [];
                }
                
                if (customers.length > 0) {
                    report += `âœ… å®¢æˆ·åˆ—è¡¨è·å–æˆåŠŸ (${customers.length}ä¸ªå®¢æˆ·)\n`;
                } else {
                    report += `âš ï¸ å®¢æˆ·åˆ—è¡¨ä¸ºç©º\n`;
                }
                
                // 3. æµ‹è¯•ç‰›åªåˆ—è¡¨
                if (bases.length > 0) {
                    report += '\n3ï¸âƒ£ æµ‹è¯•ç‰›åªåˆ—è¡¨è·å–...\n';
                    const cattleResponse = await fetch(`/api/v1/sales/cattle?base_id=${bases[0].id}&limit=5`);
                    const cattleData = await cattleResponse.json();
                    
                    let cattle = [];
                    if (cattleData.success && cattleData.data) {
                        cattle = cattleData.data.cattle || cattleData.data.items || [];
                    }
                    
                    if (cattle.length > 0) {
                        report += `âœ… ç‰›åªåˆ—è¡¨è·å–æˆåŠŸ (${cattle.length}å¤´ç‰›åª)\n`;
                    } else {
                        report += `âš ï¸ ç‰›åªåˆ—è¡¨ä¸ºç©º\n`;
                    }
                }
                
                // 4. æ€»ç»“
                report += '\nğŸ“Š æµ‹è¯•æ€»ç»“:\n';
                report += `- åŸºåœ°æœåŠ¡: ${bases.length > 0 ? 'âœ… æ­£å¸¸' : 'âš ï¸ æ— æ•°æ®'}\n`;
                report += `- å®¢æˆ·æœåŠ¡: ${customers.length > 0 ? 'âœ… æ­£å¸¸' : 'âš ï¸ æ— æ•°æ®'}\n`;
                report += `- é”€å”®æœåŠ¡: âœ… APIæ­£å¸¸å“åº”\n`;
                
                if (bases.length > 0 && customers.length > 0) {
                    report += '\nğŸ‰ æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½æµ‹è¯•é€šè¿‡ï¼\n';
                    report += 'ç°åœ¨å¯ä»¥æ­£å¸¸ä½¿ç”¨è®¢å•åˆ›å»ºåŠŸèƒ½äº†ã€‚\n';
                    resultDiv.className = 'result success';
                } else {
                    report += '\nâš ï¸ éƒ¨åˆ†åŠŸèƒ½ç¼ºå°‘æµ‹è¯•æ•°æ®\n';
                    report += 'å»ºè®®å…ˆåˆ›å»ºåŸºåœ°å’Œå®¢æˆ·æ•°æ®ã€‚\n';
                    resultDiv.className = 'result warning';
                }
                
                resultDiv.innerHTML = report;
                
            } catch (error) {
                console.error('âŒ å®Œæ•´æµç¨‹æµ‹è¯•å¤±è´¥:', error);
                resultDiv.innerHTML = `âŒ å®Œæ•´æµç¨‹æµ‹è¯•å¤±è´¥:
${error.message}

é”™è¯¯è¯¦æƒ…:
${JSON.stringify(error, null, 2)}`;
                resultDiv.className = 'result error';
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿è¡ŒåŸºç¡€æµ‹è¯•
        window.addEventListener('load', () => {
            console.log('ğŸš€ é”€å”®æ¨¡å—ä¿®å¤éªŒè¯å·¥å…·å·²åŠ è½½');
            console.log('è¯·ç‚¹å‡»æŒ‰é’®è¿›è¡Œå„é¡¹æµ‹è¯•');
        });
    </script>
</body>
</html>