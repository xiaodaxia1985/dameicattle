<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>采购订单状态流转测试</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .test-section h3 { margin-top: 0; color: #333; }
        button { padding: 8px 16px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; }
        button:hover { background: #0056b3; }
        .result { margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 3px; white-space: pre-wrap; font-family: monospace; }
        .error { background: #f8d7da; color: #721c24; }
        .success { background: #d4edda; color: #155724; }
        input, select, textarea { padding: 5px; margin: 5px; border: 1px solid #ddd; border-radius: 3px; }
        .form-group { margin: 10px 0; }
        label { display: inline-block; width: 120px; font-weight: bold; }
    </style>
</head>
<body>
    <h1>采购订单状态流转测试工具</h1>
    
    <div class="test-section">
        <h3>1. 获取采购订单列表</h3>
        <button onclick="getOrders()">获取订单列表</button>
        <div id="orders-result" class="result"></div>
    </div>

    <div class="test-section">
        <h3>2. 创建测试订单</h3>
        <div class="form-group">
            <label>供应商ID:</label>
            <input type="number" id="create-supplier-id" value="1" />
        </div>
        <div class="form-group">
            <label>供应商名称:</label>
            <input type="text" id="create-supplier-name" value="测试供应商" />
        </div>
        <div class="form-group">
            <label>基地ID:</label>
            <input type="number" id="create-base-id" value="1" />
        </div>
        <div class="form-group">
            <label>基地名称:</label>
            <input type="text" id="create-base-name" value="主基地" />
        </div>
        <div class="form-group">
            <label>订单类型:</label>
            <select id="create-order-type">
                <option value="material">物资采购</option>
                <option value="cattle">牛只采购</option>
                <option value="equipment">设备采购</option>
            </select>
        </div>
        <button onclick="createTestOrder()">创建测试订单</button>
        <div id="create-result" class="result"></div>
    </div>

    <div class="test-section">
        <h3>3. 订单状态流转测试</h3>
        <div class="form-group">
            <label>订单ID:</label>
            <input type="number" id="order-id" value="1" />
        </div>
        <button onclick="approveOrder()">审批订单</button>
        <button onclick="deliverOrder()">确认交付</button>
        <button onclick="payOrder()">确认付款</button>
        <button onclick="completeOrder()">完成订单</button>
        <button onclick="cancelOrder()">取消订单</button>
        <div id="status-result" class="result"></div>
    </div>

    <div class="test-section">
        <h3>4. 获取订单时间线</h3>
        <div class="form-group">
            <label>订单ID:</label>
            <input type="number" id="timeline-order-id" value="1" />
        </div>
        <button onclick="getOrderTimeline()">获取时间线</button>
        <div id="timeline-result" class="result"></div>
    </div>

    <script>
        // 模拟登录token
        const token = 'Bearer test-token';
        const baseUrl = '/api/v1/procurement';

        async function makeRequest(url, options = {}) {
            try {
                const response = await fetch(url, {
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': token,
                        ...options.headers
                    },
                    ...options
                });
                
                const data = await response.json();
                return { success: response.ok, data, status: response.status };
            } catch (error) {
                return { success: false, error: error.message };
            }
        }

        function displayResult(elementId, result) {
            const element = document.getElementById(elementId);
            element.className = 'result ' + (result.success ? 'success' : 'error');
            element.textContent = JSON.stringify(result, null, 2);
        }

        async function getOrders() {
            const result = await makeRequest(`${baseUrl}/orders?page=1&limit=10`);
            displayResult('orders-result', result);
        }

        async function createTestOrder() {
            const data = {
                supplierId: Number(document.getElementById('create-supplier-id').value),
                supplierName: document.getElementById('create-supplier-name').value,
                baseId: Number(document.getElementById('create-base-id').value),
                baseName: document.getElementById('create-base-name').value,
                orderType: document.getElementById('create-order-type').value,
                orderDate: new Date().toISOString().split('T')[0],
                expectedDeliveryDate: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                paymentMethod: 'transfer',
                totalAmount: 10000,
                taxAmount: 1000,
                discountAmount: 0,
                items: [
                    {
                        itemName: '测试商品',
                        specification: '标准规格',
                        quantity: 10,
                        unit: '个',
                        unitPrice: 900,
                        totalPrice: 9000,
                        remark: '测试商品'
                    }
                ]
            };

            const result = await makeRequest(`${baseUrl}/orders`, {
                method: 'POST',
                body: JSON.stringify(data)
            });
            displayResult('create-result', result);
        }

        async function approveOrder() {
            const orderId = document.getElementById('order-id').value;
            const result = await makeRequest(`${baseUrl}/orders/${orderId}/approve`, {
                method: 'POST',
                body: JSON.stringify({})
            });
            displayResult('status-result', result);
        }

        async function deliverOrder() {
            const orderId = document.getElementById('order-id').value;
            const result = await makeRequest(`${baseUrl}/orders/${orderId}/deliver`, {
                method: 'POST',
                body: JSON.stringify({
                    actualDeliveryDate: new Date().toISOString().split('T')[0],
                    deliveryNote: '测试交付'
                })
            });
            displayResult('status-result', result);
        }

        async function payOrder() {
            const orderId = document.getElementById('order-id').value;
            const result = await makeRequest(`${baseUrl}/orders/${orderId}/pay`, {
                method: 'POST',
                body: JSON.stringify({
                    paymentAmount: 10000,
                    paymentMethod: 'transfer',
                    paymentNote: '测试付款'
                })
            });
            displayResult('status-result', result);
        }

        async function completeOrder() {
            const orderId = document.getElementById('order-id').value;
            const result = await makeRequest(`${baseUrl}/orders/${orderId}/complete`, {
                method: 'POST',
                body: JSON.stringify({
                    completionNote: '测试完成'
                })
            });
            displayResult('status-result', result);
        }

        async function cancelOrder() {
            const orderId = document.getElementById('order-id').value;
            const result = await makeRequest(`${baseUrl}/orders/${orderId}/cancel`, {
                method: 'POST',
                body: JSON.stringify({
                    reason: '测试取消'
                })
            });
            displayResult('status-result', result);
        }

        async function getOrderTimeline() {
            const orderId = document.getElementById('timeline-order-id').value;
            const result = await makeRequest(`${baseUrl}/orders/${orderId}/timeline`);
            displayResult('timeline-result', result);
        }

        // 页面加载时自动获取订单列表
        window.onload = function() {
            getOrders();
        };
    </script>
</body>
</html>