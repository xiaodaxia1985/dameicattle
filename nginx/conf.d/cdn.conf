# CDN配置 - 静态资源加速

# CDN回源配置
server {
    listen 80;
    server_name cdn-origin.cattle-management.com;
    
    # 只允许CDN服务商IP访问
    # allow 1.2.3.4/24;  # CDN服务商IP段
    # deny all;
    
    # 静态资源
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot|pdf|doc|docx|xls|xlsx)$ {
        root /app/static;
        
        # 缓存设置
        expires 1y;
        add_header Cache-Control "public, immutable";
        add_header Vary Accept-Encoding;
        
        # 跨域设置
        add_header Access-Control-Allow-Origin "*";
        add_header Access-Control-Allow-Methods "GET, HEAD, OPTIONS";
        add_header Access-Control-Allow-Headers "Range";
        
        # 压缩
        gzip_static on;
        
        # 防盗链
        valid_referers none blocked server_names *.cattle-management.com;
        if ($invalid_referer) {
            return 403;
        }
    }
    
    # 上传文件
    location /uploads/ {
        alias /app/uploads/;
        
        # 缓存设置
        expires 30d;
        add_header Cache-Control "public, no-transform";
        
        # 跨域设置
        add_header Access-Control-Allow-Origin "https://cattle-management.com";
        add_header Access-Control-Allow-Methods "GET, HEAD, OPTIONS";
        
        # 安全设置
        location ~* \.(php|jsp|asp|sh|pl|py)$ {
            deny all;
        }
        
        # 防盗链
        valid_referers none blocked server_names *.cattle-management.com;
        if ($invalid_referer) {
            return 403;
        }
    }
    
    # 健康检查
    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }
}

# CDN配置映射 (在主配置中使用)
map $http_host $cdn_domain {
    default "";
    ~*cattle-management\.com "https://cdn.cattle-management.com";
}

# 静态资源CDN重写规则
map $uri $static_uri {
    ~*^/static/(.+)$ $cdn_domain/static/$1;
    ~*^/uploads/(.+)$ $cdn_domain/uploads/$1;
    default $uri;
}