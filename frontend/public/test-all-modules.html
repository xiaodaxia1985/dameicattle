<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>所有模块功能测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .button {
            background: #409eff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .button:hover {
            background: #66b1ff;
        }
        .button.success {
            background: #67c23a;
        }
        .button.error {
            background: #f56c6c;
        }
        .button.warning {
            background: #e6a23c;
        }
        .result {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .log {
            max-height: 400px;
            overflow-y: auto;
            background: #1e1e1e;
            color: #e6e6e6;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        .log-entry {
            margin-bottom: 5px;
        }
        .log-time {
            color: #888;
        }
        .log-success {
            color: #67c23a;
        }
        .log-error {
            color: #f56c6c;
        }
        .log-warning {
            color: #e6a23c;
        }
        .log-info {
            color: #409eff;
        }
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .status-card {
            background: white;
            border: 1px solid #e4e7ed;
            border-radius: 4px;
            padding: 15px;
        }
        .status-card.success {
            border-color: #67c23a;
            background: #f0f9ff;
        }
        .status-card.error {
            border-color: #f56c6c;
            background: #fef0f0;
        }
        .status-card.warning {
            border-color: #e6a23c;
            background: #fdf6ec;
        }
        .status-title {
            font-weight: bold;
            margin-bottom: 10px;
        }
        .test-results {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 10px;
            margin: 20px 0;
        }
        .test-item {
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        .test-item.success {
            background: #f0f9ff;
            border-color: #67c23a;
        }
        .test-item.error {
            background: #fef0f0;
            border-color: #f56c6c;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>所有模块功能测试</h1>
        <p>这个页面用于测试和验证所有功能模块的修复效果</p>
        
        <div>
            <button class="button" onclick="fixAllModules()">修复所有模块</button>
            <button class="button" onclick="testAllModules()">测试所有模块</button>
            <button class="button success" onclick="fixParentNodeErrors()">修复 parentNode 错误</button>
            <button class="button" onclick="testParentNodeFix()">测试 parentNode 修复</button>
            <button class="button" onclick="testSpecificModule('health')">测试健康记录</button>
            <button class="button" onclick="testSpecificModule('feeding')">测试饲养管理</button>
            <button class="button" onclick="testSpecificModule('sales')">测试销售管理</button>
            <button class="button" onclick="testSpecificModule('procurement')">测试采购管理</button>
            <button class="button" onclick="testSpecificModule('material')">测试物料管理</button>
            <button class="button warning" onclick="clearLogs()">清空日志</button>
        </div>
    </div>

    <div class="container">
        <h2>修复状态</h2>
        <div class="status-grid" id="statusGrid">
            <!-- 状态卡片将在这里动态生成 -->
        </div>
    </div>

    <div class="container">
        <h2>模块测试结果</h2>
        <div class="test-results" id="testResults">
            <!-- 测试结果将在这里显示 -->
        </div>
    </div>

    <div class="container">
        <h2>详细结果</h2>
        <div id="results"></div>
    </div>

    <div class="container">
        <h2>实时日志</h2>
        <div class="log" id="logContainer"></div>
    </div>

    <script>
        // 日志系统
        function addLog(level, message) {
            const logContainer = document.getElementById('logContainer');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${level}`;
            logEntry.innerHTML = `<span class="log-time">[${timestamp}]</span> <span class="log-${level}">${level.toUpperCase()}</span> ${message}`;
            logContainer.insertBefore(logEntry, logContainer.firstChild);
            
            // 限制日志数量
            const entries = logContainer.children;
            if (entries.length > 100) {
                logContainer.removeChild(entries[entries.length - 1]);
            }
        }

        function clearLogs() {
            document.getElementById('logContainer').innerHTML = '';
            addLog('info', '日志已清空');
        }

        // 显示结果
        function showResult(title, content, type = 'info') {
            const resultsContainer = document.getElementById('results');
            const resultDiv = document.createElement('div');
            resultDiv.className = 'result';
            resultDiv.innerHTML = `<h3>${title}</h3><pre>${JSON.stringify(content, null, 2)}</pre>`;
            resultsContainer.appendChild(resultDiv);
        }

        // 更新状态卡片
        function updateStatusCard(id, title, status, details) {
            const statusGrid = document.getElementById('statusGrid');
            let card = document.getElementById(id);
            
            if (!card) {
                card = document.createElement('div');
                card.id = id;
                card.className = 'status-card';
                statusGrid.appendChild(card);
            }
            
            card.className = `status-card ${status}`;
            card.innerHTML = `
                <div class="status-title">${title}</div>
                <div>${details}</div>
            `;
        }

        // 更新测试结果
        function updateTestResults(results) {
            const testResultsContainer = document.getElementById('testResults');
            testResultsContainer.innerHTML = '';
            
            results.forEach(result => {
                const testItem = document.createElement('div');
                testItem.className = `test-item ${result.success ? 'success' : 'error'}`;
                testItem.innerHTML = `
                    <div><strong>${result.module}</strong></div>
                    <div>状态: ${result.success ? '✓ 正常' : '✗ 异常'}</div>
                    ${result.status ? `<div>HTTP: ${result.status}</div>` : ''}
                    ${result.error ? `<div>错误: ${result.error}</div>` : ''}
                `;
                testResultsContainer.appendChild(testItem);
            });
        }

        // 修复所有模块
        async function fixAllModules() {
            addLog('info', '开始修复所有模块...');
            updateStatusCard('fixing', '修复进度', 'warning', '正在修复中...');
            
            try {
                // 修复 parentNode 错误
                fixParentNodeErrors();
                addLog('success', 'parentNode 错误修复完成');
                
                // 修复表单验证问题
                fixFormValidationIssues();
                addLog('success', '表单验证问题修复完成');
                
                // 修复数据绑定问题
                fixDataBindingIssues();
                addLog('success', '数据绑定问题修复完成');
                
                // 修复级联选择器问题
                fixCascadeSelectorIssues();
                addLog('success', '级联选择器问题修复完成');
                
                // 修复分页数据处理问题
                fixPaginationIssues();
                addLog('success', '分页数据处理问题修复完成');
                
                // 修复错误处理问题
                fixErrorHandlingIssues();
                addLog('success', '错误处理问题修复完成');
                
                updateStatusCard('fixing', '修复状态', 'success', '所有模块修复完成');
                addLog('success', '所有模块修复完成！');
                
                // 自动运行 parentNode 测试
                setTimeout(() => {
                    testParentNodeFix();
                }, 1000);
                
            } catch (error) {
                addLog('error', `修复过程中出现错误: ${error.message}`);
                updateStatusCard('fixing', '修复状态', 'error', error.message);
            }
        }

        // 测试所有模块
        async function testAllModules() {
            addLog('info', '开始测试所有模块...');
            updateStatusCard('testing', '测试进度', 'warning', '正在测试中...');
            
            const modules = [
                { name: '健康记录', endpoint: '/api/v1/health/records' },
                { name: '饲料配方', endpoint: '/api/v1/feeding/formulas' },
                { name: '饲喂记录', endpoint: '/api/v1/feeding/records' },
                { name: '销售订单', endpoint: '/api/v1/sales/orders' },
                { name: '采购订单', endpoint: '/api/v1/procurement/orders' },
                { name: '物料管理', endpoint: '/api/v1/material/materials' },
                { name: '库存管理', endpoint: '/api/v1/material/inventory' }
            ];
            
            const testResults = [];
            let successCount = 0;
            
            for (const module of modules) {
                try {
                    addLog('info', `测试 ${module.name}...`);
                    const response = await fetch(`${module.endpoint}?page=1&limit=5`);
                    const data = await response.json();
                    
                    const success = response.ok && (data.success !== false);
                    testResults.push({
                        module: module.name,
                        success: success,
                        status: response.status,
                        hasData: !!(data && (data.data || data.success))
                    });
                    
                    if (success) {
                        addLog('success', `✓ ${module.name} - 测试通过`);
                        successCount++;
                    } else {
                        addLog('error', `✗ ${module.name} - 测试失败 (${response.status})`);
                    }
                } catch (error) {
                    testResults.push({
                        module: module.name,
                        success: false,
                        error: error.message
                    });
                    addLog('error', `✗ ${module.name} - 请求失败: ${error.message}`);
                }
            }
            
            updateTestResults(testResults);
            
            const status = successCount === modules.length ? 'success' : 'warning';
            updateStatusCard('testing', '测试结果', status, `${successCount}/${modules.length} 个模块正常`);
            
            showResult('模块测试结果', testResults);
            addLog('info', `模块测试完成: ${successCount}/${modules.length} 个模块正常`);
        }

        // 测试特定模块
        async function testSpecificModule(moduleType) {
            const moduleConfigs = {
                health: { name: '健康记录', endpoints: ['/api/v1/health/records', '/api/v1/health/vaccines'] },
                feeding: { name: '饲养管理', endpoints: ['/api/v1/feeding/formulas', '/api/v1/feeding/records'] },
                sales: { name: '销售管理', endpoints: ['/api/v1/sales/orders', '/api/v1/sales/customers'] },
                procurement: { name: '采购管理', endpoints: ['/api/v1/procurement/orders', '/api/v1/procurement/suppliers'] },
                material: { name: '物料管理', endpoints: ['/api/v1/material/materials', '/api/v1/material/inventory'] }
            };
            
            const config = moduleConfigs[moduleType];
            if (!config) {
                addLog('error', `未知的模块类型: ${moduleType}`);
                return;
            }
            
            addLog('info', `开始测试 ${config.name} 模块...`);
            
            const results = [];
            for (const endpoint of config.endpoints) {
                try {
                    const response = await fetch(`${endpoint}?page=1&limit=5`);
                    const data = await response.json();
                    
                    results.push({
                        endpoint,
                        success: response.ok,
                        status: response.status,
                        data: data
                    });
                    
                    addLog(response.ok ? 'success' : 'error', 
                           `${endpoint} - ${response.ok ? '正常' : '异常'} (${response.status})`);
                } catch (error) {
                    results.push({
                        endpoint,
                        success: false,
                        error: error.message
                    });
                    addLog('error', `${endpoint} - 请求失败: ${error.message}`);
                }
            }
            
            showResult(`${config.name} 测试结果`, results);
        }

        // 修复函数实现
        function fixFormValidationIssues() {
            // 创建安全的表单验证包装器
            window.safeFormValidate = async function(formRef) {
                if (!formRef || !formRef.value) {
                    console.warn('表单引用为空');
                    return false;
                }

                if (typeof formRef.value.validate !== 'function') {
                    console.warn('表单验证方法不存在');
                    return false;
                }

                try {
                    return await new Promise((resolve) => {
                        formRef.value.validate((valid) => {
                            resolve(valid);
                        });
                    });
                } catch (error) {
                    console.error('表单验证失败:', error);
                    return false;
                }
            };
        }

        function fixDataBindingIssues() {
            // 创建全局数据处理函数
            window.safeDataAccess = function(obj, path, defaultValue = undefined) {
                if (!obj || typeof obj !== 'object') {
                    return defaultValue;
                }

                const keys = path.split('.');
                let current = obj;

                for (const key of keys) {
                    if (current == null || typeof current !== 'object' || !(key in current)) {
                        return defaultValue;
                    }
                    current = current[key];
                }

                return current !== undefined ? current : defaultValue;
            };

            window.ensureArray = function(value) {
                if (Array.isArray(value)) {
                    return value;
                }
                if (value === null || value === undefined) {
                    return [];
                }
                return [value];
            };
        }

        function fixCascadeSelectorIssues() {
            window.handleCascadeChange = function(value, targetForm, callback) {
                if (targetForm && typeof targetForm === 'object') {
                    if (!targetForm.cascade) {
                        targetForm.cascade = {};
                    }
                    
                    targetForm.cascade.baseId = value.baseId;
                    targetForm.cascade.barnId = value.barnId;
                    targetForm.cascade.cattleId = value.cattleId;
                    
                    if (callback && typeof callback === 'function') {
                        try {
                            callback();
                        } catch (error) {
                            console.error('级联选择器回调执行失败:', error);
                        }
                    }
                }
            };
        }

        function fixPaginationIssues() {
            window.normalizePaginationData = function(response, dataKey = 'data') {
                let items = [];
                let pagination = {
                    total: 0,
                    page: 1,
                    limit: 20,
                    totalPages: 0
                };

                const responseData = response?.data || response || {};
                
                if (Array.isArray(responseData)) {
                    items = responseData;
                } else if (responseData[dataKey] && Array.isArray(responseData[dataKey])) {
                    items = responseData[dataKey];
                } else if (responseData.data && Array.isArray(responseData.data)) {
                    items = responseData.data;
                } else if (responseData.items && Array.isArray(responseData.items)) {
                    items = responseData.items;
                }

                if (responseData.pagination) {
                    pagination = {
                        total: responseData.pagination.total || items.length,
                        page: responseData.pagination.page || 1,
                        limit: responseData.pagination.limit || 20,
                        totalPages: responseData.pagination.totalPages || Math.ceil((responseData.pagination.total || items.length) / (responseData.pagination.limit || 20))
                    };
                } else {
                    pagination.total = responseData.total || items.length;
                    pagination.totalPages = Math.ceil(pagination.total / pagination.limit);
                }

                return { data: items, pagination };
            };
        }

        function fixErrorHandlingIssues() {
            window.handleApiError = function(error, defaultMessage = '操作失败') {
                console.error('API错误:', error);
                
                let message = defaultMessage;
                
                if (error?.response?.data?.message) {
                    message = error.response.data.message;
                } else if (error?.message) {
                    message = error.message;
                } else if (typeof error === 'string') {
                    message = error;
                }
                
                return message;
            };
        }

        // 修复 parentNode 错误
        function fixParentNodeErrors() {
            addLog('info', '开始修复 parentNode 错误...');
            updateStatusCard('parentNode', 'parentNode 修复', 'warning', '正在修复中...');
            
            try {
                // 重写常见的DOM操作方法，添加null检查
                const originalRemoveChild = Node.prototype.removeChild;
                Node.prototype.removeChild = function(child) {
                    if (!child) {
                        console.warn('removeChild: 子节点为null');
                        return child;
                    }
                    if (!child.parentNode) {
                        console.warn('removeChild: 子节点没有父节点');
                        return child;
                    }
                    if (child.parentNode !== this) {
                        console.warn('removeChild: 子节点的父节点不匹配');
                        return child;
                    }
                    return originalRemoveChild.call(this, child);
                };

                const originalAppendChild = Node.prototype.appendChild;
                Node.prototype.appendChild = function(child) {
                    if (!child) {
                        console.warn('appendChild: 子节点为null');
                        return child;
                    }
                    return originalAppendChild.call(this, child);
                };

                const originalInsertBefore = Node.prototype.insertBefore;
                Node.prototype.insertBefore = function(newNode, referenceNode) {
                    if (!newNode) {
                        console.warn('insertBefore: 新节点为null');
                        return newNode;
                    }
                    if (referenceNode && referenceNode.parentNode !== this) {
                        console.warn('insertBefore: 参考节点的父节点不匹配');
                        return newNode;
                    }
                    return originalInsertBefore.call(this, newNode, referenceNode);
                };

                // 创建安全的DOM操作函数
                window.safeRemoveChild = function(parent, child) {
                    if (parent && child && child.parentNode === parent) {
                        try {
                            return parent.removeChild(child);
                        } catch (error) {
                            console.error('safeRemoveChild 失败:', error);
                            return null;
                        }
                    }
                    return null;
                };

                window.safeAppendChild = function(parent, child) {
                    if (parent && child) {
                        try {
                            return parent.appendChild(child);
                        } catch (error) {
                            console.error('safeAppendChild 失败:', error);
                            return null;
                        }
                    }
                    return null;
                };

                window.safeInsertBefore = function(parent, newNode, referenceNode) {
                    if (parent && newNode) {
                        try {
                            return parent.insertBefore(newNode, referenceNode);
                        } catch (error) {
                            console.error('safeInsertBefore 失败:', error);
                            return null;
                        }
                    }
                    return null;
                };

                // 创建安全的元素查找函数
                window.safeQuerySelector = function(selector, parent = document) {
                    try {
                        return parent.querySelector(selector);
                    } catch (error) {
                        console.error('safeQuerySelector 失败:', error);
                        return null;
                    }
                };

                window.safeQuerySelectorAll = function(selector, parent = document) {
                    try {
                        return parent.querySelectorAll(selector);
                    } catch (error) {
                        console.error('safeQuerySelectorAll 失败:', error);
                        return [];
                    }
                };

                updateStatusCard('parentNode', 'parentNode 修复', 'success', 'parentNode 错误修复完成');
                addLog('success', 'parentNode 错误修复完成！');
                
            } catch (error) {
                addLog('error', `parentNode 修复失败: ${error.message}`);
                updateStatusCard('parentNode', 'parentNode 修复', 'error', error.message);
            }
        }

        // 测试 parentNode 修复效果
        function testParentNodeFix() {
            addLog('info', '开始测试 parentNode 修复效果...');
            updateStatusCard('parentNodeTest', 'parentNode 测试', 'warning', '正在测试中...');
            
            let testResults = [];
            let passedTests = 0;
            
            try {
                // 测试1: 安全移除子节点
                const testDiv1 = document.createElement('div');
                const testChild1 = document.createElement('span');
                testDiv1.appendChild(testChild1);
                
                const result1 = window.safeRemoveChild(testDiv1, testChild1);
                if (result1 === testChild1) {
                    testResults.push({ test: '安全移除子节点', result: '通过' });
                    passedTests++;
                } else {
                    testResults.push({ test: '安全移除子节点', result: '失败' });
                }

                // 测试2: 移除null子节点
                const result2 = window.safeRemoveChild(testDiv1, null);
                if (result2 === null) {
                    testResults.push({ test: '移除null子节点', result: '通过' });
                    passedTests++;
                } else {
                    testResults.push({ test: '移除null子节点', result: '失败' });
                }

                // 测试3: 安全添加子节点
                const testDiv3 = document.createElement('div');
                const testChild3 = document.createElement('span');
                const result3 = window.safeAppendChild(testDiv3, testChild3);
                if (result3 === testChild3) {
                    testResults.push({ test: '安全添加子节点', result: '通过' });
                    passedTests++;
                } else {
                    testResults.push({ test: '安全添加子节点', result: '失败' });
                }

                // 测试4: 添加null子节点
                const result4 = window.safeAppendChild(testDiv3, null);
                if (result4 === null) {
                    testResults.push({ test: '添加null子节点', result: '通过' });
                    passedTests++;
                } else {
                    testResults.push({ test: '添加null子节点', result: '失败' });
                }

                // 测试5: 安全查询选择器
                const result5 = window.safeQuerySelector('body');
                if (result5 === document.body) {
                    testResults.push({ test: '安全查询选择器', result: '通过' });
                    passedTests++;
                } else {
                    testResults.push({ test: '安全查询选择器', result: '失败' });
                }

                // 测试6: 无效选择器查询
                const result6 = window.safeQuerySelector('invalid:::selector');
                if (result6 === null) {
                    testResults.push({ test: '无效选择器查询', result: '通过' });
                    passedTests++;
                } else {
                    testResults.push({ test: '无效选择器查询', result: '失败' });
                }

                const status = passedTests === testResults.length ? 'success' : 'warning';
                updateStatusCard('parentNodeTest', 'parentNode 测试', status, `${passedTests}/${testResults.length} 个测试通过`);
                
                showResult('parentNode 修复测试结果', testResults);
                addLog('info', `parentNode 测试完成: ${passedTests}/${testResults.length} 个测试通过`);
                
            } catch (error) {
                addLog('error', `parentNode 测试失败: ${error.message}`);
                updateStatusCard('parentNodeTest', 'parentNode 测试', 'error', error.message);
            }
        }

        // 页面加载时初始化
        window.addEventListener('load', function() {
            addLog('info', '所有模块测试页面已加载');
            updateStatusCard('system', '系统状态', 'success', '页面已就绪');
        });
    </script>
</body>
</html>