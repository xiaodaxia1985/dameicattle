<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>数据修复测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .button {
            background: #409eff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .button:hover {
            background: #66b1ff;
        }
        .success {
            background: #67c23a;
        }
        .error {
            background: #f56c6c;
        }
        .warning {
            background: #e6a23c;
        }
        .result {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .log {
            max-height: 400px;
            overflow-y: auto;
            background: #1e1e1e;
            color: #e6e6e6;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        .log-entry {
            margin-bottom: 5px;
        }
        .log-time {
            color: #888;
        }
        .log-success {
            color: #67c23a;
        }
        .log-error {
            color: #f56c6c;
        }
        .log-warning {
            color: #e6a23c;
        }
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .status-card {
            background: white;
            border: 1px solid #e4e7ed;
            border-radius: 4px;
            padding: 15px;
        }
        .status-card.success {
            border-color: #67c23a;
            background: #f0f9ff;
        }
        .status-card.error {
            border-color: #f56c6c;
            background: #fef0f0;
        }
        .status-title {
            font-weight: bold;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>前端数据解析问题修复测试</h1>
        <p>这个页面用于测试和修复前端数据解析问题</p>
        
        <div>
            <button class="button" onclick="fixDataIssues()">修复数据问题</button>
            <button class="button" onclick="testApiConnections()">测试API连接</button>
            <button class="button" onclick="testDataParsing()">测试数据解析</button>
            <button class="button warning" onclick="clearLogs()">清空日志</button>
        </div>
    </div>

    <div class="container">
        <h2>系统状态</h2>
        <div class="status-grid" id="statusGrid">
            <!-- 状态卡片将在这里动态生成 -->
        </div>
    </div>

    <div class="container">
        <h2>测试结果</h2>
        <div id="results"></div>
    </div>

    <div class="container">
        <h2>实时日志</h2>
        <div class="log" id="logContainer"></div>
    </div>

    <script>
        // 日志系统
        function addLog(level, message) {
            const logContainer = document.getElementById('logContainer');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${level}`;
            logEntry.innerHTML = `<span class="log-time">[${timestamp}]</span> <span class="log-${level}">${level.toUpperCase()}</span> ${message}`;
            logContainer.insertBefore(logEntry, logContainer.firstChild);
            
            // 限制日志数量
            const entries = logContainer.children;
            if (entries.length > 100) {
                logContainer.removeChild(entries[entries.length - 1]);
            }
        }

        function clearLogs() {
            document.getElementById('logContainer').innerHTML = '';
            addLog('info', '日志已清空');
        }

        // 显示结果
        function showResult(title, content, type = 'info') {
            const resultsContainer = document.getElementById('results');
            const resultDiv = document.createElement('div');
            resultDiv.className = 'result';
            resultDiv.innerHTML = `<h3>${title}</h3><pre>${JSON.stringify(content, null, 2)}</pre>`;
            resultsContainer.appendChild(resultDiv);
        }

        // 更新状态卡片
        function updateStatusCard(id, title, status, details) {
            const statusGrid = document.getElementById('statusGrid');
            let card = document.getElementById(id);
            
            if (!card) {
                card = document.createElement('div');
                card.id = id;
                card.className = 'status-card';
                statusGrid.appendChild(card);
            }
            
            card.className = `status-card ${status}`;
            card.innerHTML = `
                <div class="status-title">${title}</div>
                <div>${details}</div>
            `;
        }

        // 安全的数据访问函数
        function safeGet(obj, path, defaultValue = undefined) {
            if (!obj || typeof obj !== 'object') {
                return defaultValue;
            }

            const keys = path.split('.');
            let current = obj;

            for (const key of keys) {
                if (current == null || typeof current !== 'object' || !(key in current)) {
                    return defaultValue;
                }
                current = current[key];
            }

            return current !== undefined ? current : defaultValue;
        }

        // 确保返回数组
        function ensureArray(value) {
            if (Array.isArray(value)) {
                return value;
            }
            if (value === null || value === undefined) {
                return [];
            }
            return [value];
        }

        // 标准化列表响应
        function normalizeListResponse(response, dataKey = 'data') {
            let items = [];
            let pagination = {
                total: 0,
                page: 1,
                limit: 20,
                totalPages: 0
            };

            if (!response) {
                return { data: items, pagination };
            }

            // 处理成功响应
            const responseData = response.success ? response.data : response;

            // 尝试多种数据结构
            if (Array.isArray(responseData)) {
                items = responseData;
                pagination.total = items.length;
                pagination.totalPages = 1;
            } else if (responseData && typeof responseData === 'object') {
                // 检查特定的数据字段
                if (Array.isArray(responseData[dataKey])) {
                    items = responseData[dataKey];
                } else if (Array.isArray(responseData.data)) {
                    items = responseData.data;
                } else if (Array.isArray(responseData.items)) {
                    items = responseData.items;
                } else if (Array.isArray(responseData.records)) {
                    items = responseData.records;
                }

                // 获取分页信息
                if (responseData.pagination) {
                    pagination = {
                        total: responseData.pagination.total || items.length,
                        page: responseData.pagination.page || 1,
                        limit: responseData.pagination.limit || 20,
                        totalPages: responseData.pagination.totalPages || responseData.pagination.pages || Math.ceil((responseData.pagination.total || items.length) / (responseData.pagination.limit || 20))
                    };
                } else {
                    pagination.total = items.length;
                    pagination.totalPages = 1;
                }
            }

            return { data: items, pagination };
        }

        // 修复数据问题
        function fixDataIssues() {
            addLog('info', '开始修复数据问题...');
            
            try {
                // 清理localStorage中的损坏数据
                const localStorageKeys = Object.keys(localStorage);
                let fixedCount = 0;

                localStorageKeys.forEach(key => {
                    try {
                        const value = localStorage.getItem(key);
                        if (value) {
                            JSON.parse(value);
                        }
                    } catch (error) {
                        addLog('warning', `修复损坏的localStorage项: ${key}`);
                        localStorage.removeItem(key);
                        fixedCount++;
                    }
                });

                // 清理sessionStorage中的损坏数据
                const sessionStorageKeys = Object.keys(sessionStorage);
                sessionStorageKeys.forEach(key => {
                    try {
                        const value = sessionStorage.getItem(key);
                        if (value) {
                            JSON.parse(value);
                        }
                    } catch (error) {
                        addLog('warning', `修复损坏的sessionStorage项: ${key}`);
                        sessionStorage.removeItem(key);
                        fixedCount++;
                    }
                });

                addLog('success', `数据修复完成，共修复 ${fixedCount} 个问题`);
                updateStatusCard('dataFix', '数据修复', 'success', `修复了 ${fixedCount} 个问题`);
                
                showResult('数据修复结果', {
                    fixedCount,
                    message: '数据修复完成'
                });
            } catch (error) {
                addLog('error', `数据修复失败: ${error.message}`);
                updateStatusCard('dataFix', '数据修复', 'error', error.message);
            }
        }

        // 测试API连接
        async function testApiConnections() {
            addLog('info', '开始测试API连接...');
            
            const endpoints = [
                '/api/v1/cattle/cattle?page=1&limit=5',
                '/api/v1/base/bases?page=1&limit=5',
                '/api/v1/sales/orders?page=1&limit=5',
                '/api/v1/procurement/orders?page=1&limit=5'
            ];
            
            const results = [];
            let successCount = 0;
            
            for (const endpoint of endpoints) {
                try {
                    addLog('info', `测试: ${endpoint}`);
                    const response = await fetch(endpoint);
                    const data = await response.json();
                    
                    results.push({
                        endpoint,
                        success: true,
                        status: response.status,
                        data: data,
                        structure: Object.keys(data)
                    });
                    
                    addLog('success', `✓ ${endpoint} - 响应正常`);
                    successCount++;
                } catch (error) {
                    results.push({
                        endpoint,
                        success: false,
                        error: error.message
                    });
                    addLog('error', `✗ ${endpoint} - 请求失败: ${error.message}`);
                }
            }
            
            const status = successCount === endpoints.length ? 'success' : 'error';
            updateStatusCard('apiTest', 'API连接测试', status, `${successCount}/${endpoints.length} 个API正常`);
            
            showResult('API连接测试结果', results);
            addLog('info', `API连接测试完成: ${successCount}/${endpoints.length} 个API正常`);
        }

        // 测试数据解析
        async function testDataParsing() {
            addLog('info', '开始测试数据解析...');
            
            try {
                // 测试牛只数据解析
                const cattleResponse = await fetch('/api/v1/cattle/cattle?page=1&limit=5');
                const cattleData = await cattleResponse.json();
                const normalizedCattle = normalizeListResponse(cattleData, 'cattle');
                
                addLog('success', `牛只数据解析成功: ${normalizedCattle.data.length} 条记录`);
                
                // 测试基地数据解析
                const baseResponse = await fetch('/api/v1/base/bases?page=1&limit=5');
                const baseData = await baseResponse.json();
                const normalizedBase = normalizeListResponse(baseData, 'bases');
                
                addLog('success', `基地数据解析成功: ${normalizedBase.data.length} 条记录`);
                
                const testResults = {
                    cattle: {
                        original: cattleData,
                        normalized: normalizedCattle,
                        count: normalizedCattle.data.length
                    },
                    base: {
                        original: baseData,
                        normalized: normalizedBase,
                        count: normalizedBase.data.length
                    }
                };
                
                updateStatusCard('dataParsing', '数据解析测试', 'success', '所有数据解析正常');
                showResult('数据解析测试结果', testResults);
                addLog('success', '数据解析测试完成');
                
            } catch (error) {
                addLog('error', `数据解析测试失败: ${error.message}`);
                updateStatusCard('dataParsing', '数据解析测试', 'error', error.message);
            }
        }

        // 页面加载时初始化
        window.addEventListener('load', function() {
            addLog('info', '数据修复测试页面已加载');
            updateStatusCard('system', '系统状态', 'success', '页面已就绪');
        });
    </script>
</body>
</html>