<!DOCTYPE html>
<html>
<head>
    <title>Token调试工具</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        pre { background: #f5f5f5; padding: 10px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>Token调试工具</h1>
    
    <div class="section">
        <h2>步骤1: 检查当前认证状态</h2>
        <button onclick="checkCurrentAuth()">检查当前认证状态</button>
        <div id="authStatus"></div>
    </div>
    
    <div class="section">
        <h2>步骤2: 重新登录获取新Token</h2>
        <button onclick="freshLogin()">重新登录</button>
        <div id="loginResult"></div>
    </div>
    
    <div class="section">
        <h2>步骤3: 测试Token有效性</h2>
        <button onclick="testTokenValidity()">测试Token</button>
        <div id="tokenTest"></div>
    </div>
    
    <div class="section">
        <h2>步骤4: 测试具体API</h2>
        <button onclick="testFeedingAPI()">测试饲喂API</button>
        <button onclick="testHealthAPI()">测试健康API</button>
        <div id="apiTest"></div>
    </div>
    
    <script>
        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
            element.innerHTML += `<p class="${className}">${message}</p>`;
        }
        
        function checkCurrentAuth() {
            const authStatus = document.getElementById('authStatus');
            authStatus.innerHTML = '<h3>当前认证状态:</h3>';
            
            const token = localStorage.getItem('token');
            const user = localStorage.getItem('user');
            const permissions = localStorage.getItem('permissions');
            
            log('authStatus', `Token存在: ${!!token}`, token ? 'success' : 'error');
            
            if (token) {
                log('authStatus', `Token长度: ${token.length}`);
                log('authStatus', `Token前30个字符: ${token.substring(0, 30)}...`);
                
                // 尝试解析JWT payload (不验证签名)
                try {
                    const parts = token.split('.');
                    if (parts.length === 3) {
                        const payload = JSON.parse(atob(parts[1]));
                        log('authStatus', `Token payload: <pre>${JSON.stringify(payload, null, 2)}</pre>`);
                        
                        const now = Math.floor(Date.now() / 1000);
                        if (payload.exp) {
                            const expired = now > payload.exp;
                            log('authStatus', `Token过期状态: ${expired ? '已过期' : '未过期'}`, expired ? 'error' : 'success');
                            log('authStatus', `过期时间: ${new Date(payload.exp * 1000).toLocaleString()}`);
                        }
                    }
                } catch (e) {
                    log('authStatus', `Token解析失败: ${e.message}`, 'error');
                }
            }
            
            log('authStatus', `用户信息存在: ${!!user}`, user ? 'success' : 'error');
            log('authStatus', `权限信息存在: ${!!permissions}`, permissions ? 'success' : 'error');
            
            if (user) {
                try {
                    const userData = JSON.parse(user);
                    log('authStatus', `用户信息: <pre>${JSON.stringify(userData, null, 2)}</pre>`);
                } catch (e) {
                    log('authStatus', `用户信息解析失败: ${e.message}`, 'error');
                }
            }
        }
        
        async function freshLogin() {
            const loginResult = document.getElementById('loginResult');
            loginResult.innerHTML = '<h3>重新登录:</h3>';
            
            // 先清除旧的认证信息
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            localStorage.removeItem('permissions');
            localStorage.removeItem('tokenExpiration');
            
            log('loginResult', '已清除旧的认证信息');
            
            try {
                const response = await fetch('/api/v1/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        username: 'admin',
                        password: 'admin123'
                    })
                });
                
                log('loginResult', `登录请求状态: ${response.status}`);
                
                const data = await response.json();
                log('loginResult', `登录响应: <pre>${JSON.stringify(data, null, 2)}</pre>`);
                
                if (response.ok && data.success) {
                    localStorage.setItem('token', data.data.token);
                    localStorage.setItem('user', JSON.stringify(data.data.user));
                    localStorage.setItem('permissions', JSON.stringify(data.data.permissions || []));
                    
                    // 设置token过期时间
                    if (data.data.expiresIn) {
                        const expirationTime = Date.now() + (data.data.expiresIn * 1000);
                        localStorage.setItem('tokenExpiration', expirationTime.toString());
                    }
                    
                    log('loginResult', '✅ 登录成功，新的认证信息已保存', 'success');
                } else {
                    log('loginResult', `❌ 登录失败: ${data.message || '未知错误'}`, 'error');
                }
            } catch (error) {
                log('loginResult', `❌ 登录请求异常: ${error.message}`, 'error');
            }
        }
        
        async function testTokenValidity() {
            const tokenTest = document.getElementById('tokenTest');
            tokenTest.innerHTML = '<h3>Token有效性测试:</h3>';
            
            const token = localStorage.getItem('token');
            if (!token) {
                log('tokenTest', '❌ 没有找到token，请先登录', 'error');
                return;
            }
            
            try {
                // 测试auth服务的profile接口
                const response = await fetch('/api/v1/auth/profile', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                log('tokenTest', `Auth Profile API状态: ${response.status}`);
                
                if (response.ok) {
                    const data = await response.json();
                    log('tokenTest', '✅ Token有效，认证服务正常', 'success');
                    log('tokenTest', `Profile响应: <pre>${JSON.stringify(data, null, 2)}</pre>`);
                } else {
                    const errorText = await response.text();
                    log('tokenTest', `❌ Token验证失败: ${errorText}`, 'error');
                }
            } catch (error) {
                log('tokenTest', `❌ Token测试异常: ${error.message}`, 'error');
            }
        }
        
        async function testFeedingAPI() {
            const apiTest = document.getElementById('apiTest');
            apiTest.innerHTML += '<h3>饲喂API测试:</h3>';
            
            const token = localStorage.getItem('token');
            if (!token) {
                log('apiTest', '❌ 没有找到token，请先登录', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/v1/feeding/formulas', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                log('apiTest', `饲喂API状态: ${response.status}`);
                
                if (response.ok) {
                    const data = await response.json();
                    log('apiTest', '✅ 饲喂API调用成功', 'success');
                    log('apiTest', `饲喂API响应: <pre>${JSON.stringify(data, null, 2)}</pre>`);
                } else {
                    const errorText = await response.text();
                    log('apiTest', `❌ 饲喂API调用失败: ${errorText}`, 'error');
                }
            } catch (error) {
                log('apiTest', `❌ 饲喂API测试异常: ${error.message}`, 'error');
            }
        }
        
        async function testHealthAPI() {
            const apiTest = document.getElementById('apiTest');
            if (!document.getElementById('apiTest').innerHTML.includes('健康API测试')) {
                apiTest.innerHTML += '<h3>健康API测试:</h3>';
            }
            
            const token = localStorage.getItem('token');
            if (!token) {
                log('apiTest', '❌ 没有找到token，请先登录', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/v1/health/records', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                log('apiTest', `健康API状态: ${response.status}`);
                
                if (response.ok) {
                    const data = await response.json();
                    log('apiTest', '✅ 健康API调用成功', 'success');
                    log('apiTest', `健康API响应: <pre>${JSON.stringify(data, null, 2)}</pre>`);
                } else {
                    const errorText = await response.text();
                    log('apiTest', `❌ 健康API调用失败: ${errorText}`, 'error');
                }
            } catch (error) {
                log('apiTest', `❌ 健康API测试异常: ${error.message}`, 'error');
            }
        }
    </script>
</body>
</html>